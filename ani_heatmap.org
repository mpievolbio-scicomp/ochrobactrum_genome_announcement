#+name: ANI heatmap
#+author: Carsten Fortmann-Grote (@CFGrote)
#+date: [2025-12-11 Thu] 
#+property: header-args:R :results output :tangle fastani_heatmap.R :noweb yes :eval yes :session rbioinfo


* Data exploration
:PROPERTIES:
:ID:       35471fb5-7cb3-459d-a6a8-b999e734cacb
:END:
The data produced by running =fastANI= on our our data produced the following table.
** Original data
:PROPERTIES:
:ID:       aa04eaa7-59a6-40f6-bc89-16d3e4c6dc6c
:END:
| QUERY                       | REFERENCE                   | ANI_ESTIMATE |
|-----------------------------+-----------------------------+--------------|
| O.pituitosum NV9            | P.saccharolyticum CCUG33852 |      77.5564 |
| O.pituitosum NV9            | P.saccharolyticum DSM25260  |      77.5571 |
| P.saccharolyticum DSM25260  | O.pituitosum NV9            |      77.5934 |
| P.saccharolyticum DSM25260  | O.pituitosum PH15           |      77.5965 |
| Pseudochrobactrum IV4       | B.pituitosa BU72            |      77.6148 |
| P.saccharolyticum CCUG33852 | O.pituitosum NV9            |      77.6243 |
| P.saccharolyticum CCUG33852 | O.pituitosum PH15           |      77.6272 |
| P.saccharolyticum DSM25260  | O.pituitosum IV11           |      77.6331 |
| P.saccharolyticum DSM25260  | O.pituitosum CCUG50899      |      77.6428 |
| P.saccharolyticum DSM25260  | O.pituitosum PH4            |        77.65 |
| P.saccharolyticum DSM25260  | O.pituitosum NH1            |      77.6545 |
| P.saccharolyticum DSM25260  | B.pituitosa BU72            |      77.6575 |
| O.pituitosum PH4            | P.saccharolyticum DSM25260  |      77.6628 |
| Pseudochrobactrum IV4       | O.pituitosum IV11           |       77.666 |
| P.saccharolyticum CCUG33852 | O.pituitosum NH1            |      77.6827 |
| O.pituitosum IV11           | P.saccharolyticum DSM25260  |      77.6869 |
| O.pituitosum IV11           | Pseudochrobactrum NH11      |       77.687 |
| P.saccharolyticum CCUG33852 | O.pituitosum IV11           |      77.6927 |
| O.pituitosum NH1            | P.saccharolyticum DSM25260  |      77.6982 |
| B.pituitosa BU72            | P.saccharolyticum DSM25260  |      77.7082 |
| O.pituitosum PH4            | P.saccharolyticum CCUG33852 |        77.72 |
| B.pituitosa BU72            | Pseudochrobactrum NH11      |      77.7227 |
| P.saccharolyticum CCUG33852 | B.pituitosa BU72            |      77.7238 |
| O.pituitosum IV11           | P.saccharolyticum CCUG33852 |      77.7345 |
| O.pituitosum CCUG50899      | P.saccharolyticum DSM25260  |      77.7393 |
| O.pituitosum NH1            | P.saccharolyticum CCUG33852 |      77.7447 |
| O.pituitosum PH15           | P.saccharolyticum DSM25260  |      77.7483 |
| Pseudochrobactrum NH11      | O.pituitosum CCUG50899      |      77.7538 |
| B.pituitosa BU72            | Pseudochrobactrum IV4       |      77.7613 |
| B.pituitosa BU72            | P.saccharolyticum CCUG33852 |      77.7657 |
| O.pituitosum CCUG50899      | P.saccharolyticum CCUG33852 |      77.7897 |
| P.saccharolyticum CCUG33852 | O.pituitosum CCUG50899      |      77.8055 |
| P.saccharolyticum CCUG33852 | O.pituitosum PH4            |      77.8086 |
| O.pituitosum PH4            | Pseudochrobactrum IV4       |       77.812 |
| Pseudochrobactrum NH11      | B.pituitosa BU72            |      77.8143 |
| O.pituitosum PH15           | P.saccharolyticum CCUG33852 |      77.8224 |
| O.pituitosum PH4            | Pseudochrobactrum PH5       |      77.8335 |
| B.pituitosa BU72            | Pseudochrobactrum PH5       |      77.8382 |
| Pseudochrobactrum IV4       | O.pituitosum NH1            |      77.8428 |
| Pseudochrobactrum NH11      | O.pituitosum IV11           |      77.8508 |
| Pseudochrobactrum IV4       | O.pituitosum PH4            |      77.8561 |
| O.pituitosum NV9            | Pseudochrobactrum NH11      |      77.8864 |
| O.pituitosum PH4            | Pseudochrobactrum NH11      |      77.8956 |
| O.pituitosum NV9            | Pseudochrobactrum IV4       |      77.9136 |
| O.pituitosum NH1            | Pseudochrobactrum NH11      |      77.9164 |
| Pseudochrobactrum NH11      | O.pituitosum NV9            |      77.9248 |
| Pseudochrobactrum IV4       | O.pituitosum CCUG50899      |      77.9249 |
| O.pituitosum NV9            | Pseudochrobactrum PH5       |      77.9257 |
| Pseudochrobactrum IV4       | O.pituitosum NV9            |      77.9291 |
| Pseudochrobactrum IV4       | O.pituitosum PH15           |      77.9371 |
| Pseudochrobactrum NH11      | O.pituitosum PH4            |      77.9646 |
| Pseudochrobactrum PH5       | B.pituitosa BU72            |      77.9756 |
| Pseudochrobactrum NH11      | O.pituitosum PH15           |      77.9761 |
| O.pituitosum IV11           | Pseudochrobactrum PH5       |      78.0064 |
| O.pituitosum CCUG50899      | Pseudochrobactrum NH11      |      78.0117 |
| Pseudochrobactrum PH5       | O.pituitosum CCUG50899      |      78.0307 |
| O.pituitosum IV11           | Pseudochrobactrum IV4       |      78.0328 |
| O.pituitosum PH15           | Pseudochrobactrum NH11      |      78.0359 |
| Pseudochrobactrum PH5       | O.pituitosum IV11           |      78.0393 |
| Pseudochrobactrum NH11      | O.pituitosum NH1            |       78.042 |
| O.pituitosum NH1            | Pseudochrobactrum IV4       |       78.048 |
| Pseudochrobactrum PH5       | O.pituitosum PH4            |      78.0613 |
| Pseudochrobactrum PH5       | O.pituitosum NV9            |      78.0892 |
| O.pituitosum CCUG50899      | Pseudochrobactrum IV4       |       78.091 |
| O.pituitosum CCUG50899      | Pseudochrobactrum PH5       |      78.1151 |
| O.pituitosum PH15           | Pseudochrobactrum IV4       |      78.1668 |
| O.pituitosum NH1            | Pseudochrobactrum PH5       |      78.3472 |
| Pseudochrobactrum PH5       | O.pituitosum NH1            |       78.509 |
| O.pituitosum PH15           | Pseudochrobactrum PH5       |      78.5989 |
| Pseudochrobactrum PH5       | O.pituitosum PH15           |       78.639 |
| Pseudochrobactrum PH5       | Pseudochrobactrum NH11      |      96.1482 |
| Pseudochrobactrum IV4       | Pseudochrobactrum NH11      |      96.1565 |
| Pseudochrobactrum NH11      | Pseudochrobactrum PH5       |      96.1675 |
| Pseudochrobactrum NH11      | Pseudochrobactrum IV4       |      96.1811 |
| P.saccharolyticum DSM25260  | Pseudochrobactrum PH5       |      96.1847 |
| P.saccharolyticum CCUG33852 | Pseudochrobactrum PH5       |      96.2042 |
| Pseudochrobactrum PH5       | P.saccharolyticum DSM25260  |      96.2186 |
| Pseudochrobactrum PH5       | P.saccharolyticum CCUG33852 |      96.2202 |
| Pseudochrobactrum IV4       | P.saccharolyticum DSM25260  |      96.2722 |
| P.saccharolyticum CCUG33852 | Pseudochrobactrum IV4       |      96.2783 |
| P.saccharolyticum DSM25260  | Pseudochrobactrum IV4       |      96.2921 |
| Pseudochrobactrum IV4       | P.saccharolyticum CCUG33852 |      96.2934 |
| Pseudochrobactrum IV4       | Pseudochrobactrum PH5       |      96.3125 |
| P.saccharolyticum CCUG33852 | Pseudochrobactrum NH11      |      96.3288 |
| P.saccharolyticum DSM25260  | Pseudochrobactrum NH11      |      96.3453 |
| Pseudochrobactrum PH5       | Pseudochrobactrum IV4       |       96.354 |
| Pseudochrobactrum NH11      | P.saccharolyticum CCUG33852 |      96.3568 |
| Pseudochrobactrum NH11      | P.saccharolyticum DSM25260  |      96.3628 |
| O.pituitosum CCUG50899      | O.pituitosum IV11           |      97.9973 |
| O.pituitosum IV11           | O.pituitosum CCUG50899      |      98.0089 |
| O.pituitosum IV11           | B.pituitosa BU72            |      98.0453 |
| B.pituitosa BU72            | O.pituitosum IV11           |      98.0585 |
| O.pituitosum IV11           | O.pituitosum PH4            |      98.1054 |
| O.pituitosum PH4            | O.pituitosum IV11           |       98.145 |
| O.pituitosum CCUG50899      | O.pituitosum PH15           |      98.2591 |
| B.pituitosa BU72            | O.pituitosum PH15           |      98.2681 |
| O.pituitosum PH15           | B.pituitosa BU72            |      98.2837 |
| B.pituitosa BU72            | O.pituitosum CCUG50899      |      98.2929 |
| O.pituitosum CCUG50899      | B.pituitosa BU72            |       98.299 |
| B.pituitosa BU72            | O.pituitosum NV9            |      98.3015 |
| O.pituitosum PH4            | O.pituitosum PH15           |      98.3028 |
| O.pituitosum CCUG50899      | O.pituitosum PH4            |      98.3142 |
| O.pituitosum PH15           | O.pituitosum CCUG50899      |      98.3143 |
| O.pituitosum PH15           | O.pituitosum PH4            |      98.3511 |
| O.pituitosum PH4            | O.pituitosum CCUG50899      |      98.3591 |
| O.pituitosum NV9            | B.pituitosa BU72            |       98.371 |
| B.pituitosa BU72            | O.pituitosum NH1            |      98.3927 |
| O.pituitosum PH4            | B.pituitosa BU72            |      98.4017 |
| B.pituitosa BU72            | O.pituitosum PH4            |      98.4023 |
| O.pituitosum NH1            | B.pituitosa BU72            |      98.4628 |
| O.pituitosum NV9            | O.pituitosum PH4            |      98.4828 |
| O.pituitosum NH1            | O.pituitosum CCUG50899      |      98.4997 |
| O.pituitosum PH4            | O.pituitosum NV9            |      98.5013 |
| O.pituitosum NH1            | O.pituitosum PH4            |      98.5104 |
| O.pituitosum PH4            | O.pituitosum NH1            |      98.5197 |
| O.pituitosum CCUG50899      | O.pituitosum NH1            |      98.5216 |
| O.pituitosum NV9            | O.pituitosum CCUG50899      |      98.5265 |
| O.pituitosum CCUG50899      | O.pituitosum NV9            |      98.5303 |
| O.pituitosum IV11           | O.pituitosum NH1            |      98.6263 |
| O.pituitosum NH1            | O.pituitosum IV11           |      98.6391 |
| O.pituitosum IV11           | O.pituitosum PH15           |      98.7947 |
| O.pituitosum PH15           | O.pituitosum IV11           |      98.8264 |
| O.pituitosum IV11           | O.pituitosum NV9            |      98.8856 |
| O.pituitosum NV9            | O.pituitosum IV11           |      98.9332 |
| O.pituitosum NH1            | O.pituitosum PH15           |      98.9969 |
| O.pituitosum PH15           | O.pituitosum NH1            |      99.0194 |
| O.pituitosum NH1            | O.pituitosum NV9            |      99.2807 |
| O.pituitosum NV9            | O.pituitosum NH1            |      99.3008 |
| O.pituitosum NV9            | O.pituitosum PH15           |      99.6654 |
| O.pituitosum PH15           | O.pituitosum NV9            |      99.6718 |
| P.saccharolyticum CCUG33852 | P.saccharolyticum DSM25260  |      99.9972 |
| P.saccharolyticum DSM25260  | P.saccharolyticum CCUG33852 |      99.9992 |

 It contains 10 assembled genomes
and 4 reference type strains. Before analyzing it further, some cleanup steps need to be taken:
- remove strain NV9 because of inferior data quality
- remove redundant type strains P.sac. CCUG33852 and O.pit. BU72 being close to 100% identical to their respective
  counterparts P.sac. DSM25260 and O.pit. CCUG50899.
- use isolate identifiers (MPB numbers) instead of sample titles in strain names
|              |          |                                   |
| Sample Title | Isolate  | Organism                          |
|--------------+----------+-----------------------------------|
| IV11         | MPB25535 | Ochrobactrum pituitosum           |
| PH15         | MPB25415 | Ochrobactrum pituitosum           |
| PH4          | MPB25440 | Ochrobactrum pituitosum           |
| NH1          | MPB25478 | Ochrobactrum pituitosum           |
| IV4          | MPB25528 | Pseudochrobactrum saccharolyticum |
| NH11         | MPB25488 | Pseudochrobactrum saccharolyticum |
| PH5          | MPB25441 | Pseudochrobactrum saccharolyticum |


We run the following shell command:
#+begin_src shell
  cat FastANI_Results.csv \
    | grep -v "CCUG33852" \
    | grep -v "BU72" \
    | grep -v "NV9" \
    | sed 's/IV11/MPB25535/g' \
    | sed 's/PH15/MPB25415/g' \
    | sed 's/PH4/MPB25440/g' \
    | sed 's/NH11/MPB25488/g' \
    | sed 's/NH1/MPB25478/g' \
    | sed 's/IV4/MPB25528/g' \
    | sed 's/PH5/MPB25441/g' \
    | sed 's/Pseudochrobactrum M/M/g' \
    | sed 's/O\.pituitosum M/M/g'  \
    | sed 's/O\.pituitosum/O.pit./g' \
    | sed 's/P\.saccharolyticum/P.sac./g' \
    > FastANI_Results_clean.csv
  cat FastANI_Results_clean.csv
#+end_src


* R script for heatmap plot
:PROPERTIES:
:ID:       206c49a5-a191-4f73-9f27-bc35a6d1498b
:END:
The following libraries are needed to produce a formatted clustered heatmap from the filtered ANI data:
#+name: libraries
#+begin_src R :results values quiet :session rbioinfo
  # Load libraries
  library('ggcorrheatmap')
  library('reshape2')
  library('ggplot2')
#+end_src

We load the data using =read.csv= treating strings as values, not as factors:
#+begin_src R :session rbioinfo :results values quiet
  # Read data
  data <- read.csv("FastANI_Results_clean.csv", stringsAsFactors = FALSE)
#+end_src


Next, we reshape the data into a wide format using =dcast=.
We need to make the QUERY values the row names and the REFERENCE values the column names
#+begin_src R :session rbioinfo :results values quiet
  # Reshape into square matrix
  data_matrix <- dcast(data, QUERY ~ REFERENCE, value.var = "ANI_ESTIMATE")
#+end_src

Finally, we remove the QUERY column and insert it as rownames
#+begin_src R :session rbioinfo
  # Remove the QUERY column which is now row names 
  heatmap_data <- as.matrix(data_matrix[, -1])  
  
  # Set QUERY as row names
  rownames(heatmap_data) <- data_matrix$QUERY  
#+end_src

#+RESULTS:

The table reports ANI values as percent identity, we'll recast it to a ratio by dividing by 100

#+begin_src R :session rbioinfo :results values quiet
  # Scale to 0 < ANI < 1.
  heatmap_data <- heatmap_data * 0.01
#+end_src

Finally, we plot the heatmap using =ggplot2::gghm=. We cluster rows and columns but do not render the dendogram. Each
cell is labeled by the corresponding ANI value. We plot only the upper left triangle of the symmetric matrix and
remove the diagonal as it does not add any information. Remaining options and the added =theme= layer are for stylistic
elements. The plot is saved in high resolution to pdf and png files.
#+begin_src R :session rbioinfo :results output file link :file ani_heatmap.png
  # Plot heatmap
  gghm(heatmap_data,
       layout='topleft',
       col_scale='YlGnBu',
       bins=5,
       na_remove=TRUE,
       cell_labels=TRUE,
       cluster_rows=TRUE,
       cluster_cols=TRUE,
       show_dend_rows=FALSE,
       show_dend_cols=FALSE,
       cell_label_digits=3,
       dend_height=0.0,
       legend_order=NA,
       cell_label_size=6,
       ) + theme(axis.text.x = element_text(size=18), axis.text.y = element_text(size=18))
  ggsave('ani_heatmap.pdf', dpi=600)
  ggsave('ani_heatmap.png', dpi=150)
#+end_src

#+RESULTS:
[[file:ani_heatmap.png]]




